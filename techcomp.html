<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Decoration Detective</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Comic-Sans&display=swap" rel="stylesheet">
<style>
  body {
    font-family:'Comic-Sans';
    margin:0;
    background:linear-gradient(to bottom, #dcb135, #e67a37);
    overflow-x:hidden;
  }

  h1 {
    text-align:center;
    color:#b71c1c;
    font-size:2em;
    margin:15px 0;
    text-shadow:1px 1px 3px white;
  }

  @media (max-width: 600px) {
    h1 { font-size:1.5em; }
  }

  #map {
    height:70vh;
    max-width:95%;
    margin:10px auto;
    border-radius:12px;
    box-shadow:0 0 15px rgba(0,0,0,0.3);
  }

  form {
    text-align:center;
    margin:15px auto;
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    gap:10px;
  }

  @media (max-width: 400px) {
    form { flex-direction: column; gap:8px; }
  }

  input {
    padding:10px;
    font-size:16px;
    border-radius:6px;
    border:1px solid #ccc;
  }

  button {
    padding:12px 20px;
    font-size:16px;
    background:#c62828;
    color:white;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-weight:bold;
  }

  button:hover { background:#b71c1c; }

  .snowflake {
    position:fixed;
    top:-10px;
    z-index:9999;
    user-select:none;
    pointer-events:none;
    font-size:1em;
    color:white;
    animation-name:fall;
    animation-duration:10s;
    animation-iteration-count:infinite;
  }

  @keyframes fall {
    0% { transform:translateY(0) rotate(0deg); opacity:1; }
    100% { transform:translateY(100vh) rotate(360deg); opacity:0.7; }
  }
</style>
</head>
<body>

<h1>â˜•Decoration DetectiveðŸ¦ƒ<p>(THIS IS NOT MEANT TO BE USED WITH HARMFUL INTENT!)</p></h1>
<div id="map"></div>

<form id="coordForm">
  <input type="number" id="lat" placeholder="Latitude (optional)" step="any" inputmode="decimal" autocomplete="off">
  <input type="number" id="lng" placeholder="Longitude (optional)" step="any" inputmode="decimal" autocomplete="off">
  <input type="text" id="address" placeholder="Address (optional)" autocomplete="street-address">
  <input type="text" id="label" placeholder="Location Name" autocomplete="off">
  <button type="submit">Enter!</button>
  <button id="undoBtn" type="button">Undo Last Entered Location (WARNING, AFFECTS <u>EVERYBODY</u>)</button>
</form>

<!-- Background Christmas music -->
<audio id="bgMusic" loop>
  <source src="wish.mp3" type="audio/mpeg">
  Your browser does not support the audio element.
</audio>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* JSONBin setup */
const BIN_ID = "68fa2921d0ea881f40b58c70"; // Replace with your bin ID
const API_KEY = "$2a$10$uU2oI6jq6b9iB5oQak/C6.9MnUs86rhRGb.M0KBmMwx4J8K6zGowu"; // Optional if bin is public

/* Initialize map with touchscreen support */
const map = L.map('map', {
  worldCopyJump: false,
  maxBoundsViscosity: 1.0,
  noWrap: true,
  tap: true,
  touchZoom: true,
  dragging: true
}).setView([20,0],2);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'&copy; OpenStreetMap contributors',
  noWrap:true
}).addTo(map);

/* Red marker icon */
const redIcon = L.icon({
  iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
  shadowUrl:'https://unpkg.com/leaflet/dist/images/marker-shadow.png',
  iconSize:[25,41],
  iconAnchor:[12,41],
  popupAnchor:[1,-34],
  shadowSize:[41,41]
});

let markers = [];

/* Load markers from JSONBin */
async function loadMarkers() {
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": API_KEY }
    });
    const data = await res.json();
    let saved = data.record || [];
    saved = saved.filter(m => !(m.lat===0 && m.lng===0 && m.label==="placeholder"));
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    saved.forEach(c => {
      const m = L.marker([c.lat,c.lng],{icon:redIcon})
        .addTo(map)
        .bindPopup(`<b>${c.label||"Unnamed Location"}</b><br>â˜•${c.lat.toFixed(3)}, ${c.lng.toFixed(3)})`);
      markers.push(m);
    });
  } catch(err) {
    console.error("Could not load markers:",err);
  }
}

/* Save new marker to JSONBin */
async function saveMarker(lat,lng,label) {
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": API_KEY }
    });
    const data = await res.json();
    let saved = data.record || [];
    saved = saved.filter(m => !(m.lat===0 && m.lng===0 && m.label==="placeholder"));
    saved.push({lat,lng,label});
    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method:"PUT",
      headers: { "Content-Type":"application/json", "X-Master-Key":API_KEY },
      body: JSON.stringify(saved)
    });
    loadMarkers();
  } catch(err) {
    console.error("Could not save marker:",err);
  }
}

/* Form submit handler */
document.getElementById('coordForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const latVal = parseFloat(document.getElementById('lat').value);
  const lngVal = parseFloat(document.getElementById('lng').value);
  const addressVal = document.getElementById('address').value.trim();
  const labelVal = document.getElementById('label').value || "Unnamed Location";

  if(!isNaN(latVal) && !isNaN(lngVal)) {
    saveMarker(latVal,lngVal,labelVal);
  } else if(addressVal) {
    try {
      const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addressVal)}`);
      const geoData = await geoRes.json();
      if(geoData.length===0) return alert("Address not found!");
      const lat = parseFloat(geoData[0].lat);
      const lng = parseFloat(geoData[0].lon);
      saveMarker(lat,lng,labelVal);
    } catch(err) {
      console.error("Geocoding error:",err);
      alert("Failed to get coordinates from address.");
    }
  } else {
    alert("Enter either lat/lng or an address.");
  }

  e.target.reset();
});

/* Snow effect */
function createSnowflake(){
  const snow=document.createElement('div');
  snow.className='snowflake';
  const colors=['#fff','#d32f2f','#388e3c','#fbc02d'];
  snow.style.color=colors[Math.floor(Math.random()*colors.length)];
  snow.style.left=Math.random()*window.innerWidth+'px';
  snow.style.fontSize=(Math.random()*8+8)+'px'; // smaller on mobile
  snow.style.animationDuration=(Math.random()*5+5)+'s';
  snow.innerText='ðŸ';
  document.body.appendChild(snow);
  setTimeout(()=>snow.remove(),10000);
}
setInterval(createSnowflake,200);

/* Background music */
const bgMusic = document.getElementById('bgMusic');
function enableMusic() {
  bgMusic.play().catch(e => console.log("Autoplay blocked, waiting for click/tap."));
  window.removeEventListener('click', enableMusic);
  window.removeEventListener('touchstart', enableMusic);
}
window.addEventListener('click', enableMusic);
window.addEventListener('touchstart', enableMusic);

/* Load markers on start */
loadMarkers();
document.getElementById('undoBtn').addEventListener('click', async () => {
  if(markers.length === 0) return alert("No markers to undo!");

  // Remove the last marker from the map
  const lastMarker = markers.pop();
  map.removeLayer(lastMarker);

  // Update JSONBin
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": API_KEY }
    });
    const data = await res.json();
    let saved = data.record || [];

    // Remove the last saved marker (or match by coordinates/label)
    saved.pop(); // simplest if we just undo the last one
    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
      body: JSON.stringify(saved)
    });

  } catch(err) {
    console.error("Could not update markers after undo:", err);
    alert("Failed to update markers on server.");
  }
});
</script>

<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"e7e957facfc54525a08210243be3e9e0","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>